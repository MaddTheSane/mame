/***************************************************************************

  vidhrdw.c

  Functions to emulate the video hardware of the machine.

***************************************************************************/

#include "driver.h"
#include "vidhrdw/generic.h"



unsigned char *invaders_videoram;

/* palette colors (see drivers/8080bw.c) */
enum { BLACK, RED, GREEN, YELLOW, WHITE, CYAN, PURPLE };


static unsigned char astinvad_lookup[32][32] =
{
      {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
      {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
      {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
      {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
      {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0},
      {0x0,0x4,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x2,0x2,0x2,0x5,0x5,0x5,0x3,0x3,0x3,0x7,0x6,0x6,0x6,0x1,0x1,0x1,0x4,0x4,0x4,0x6,0x1,0x7,0x0},
      {0x0,0x4,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x2,0x2,0x2,0x4,0x1,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x7,0x0},
      {0x0,0x4,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x1,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x7,0x0},
      {0x0,0x4,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x1,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x7,0x0},
      {0x0,0x4,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x5,0x0},
      {0x0,0x4,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x5,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x5,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x5,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x5,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x5,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x5,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x1,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x1,0x7,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x1,0x7,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x1,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x5,0x1,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x6,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x6,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x5,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x6,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x1,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x6,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x6,0x6,0x6,0x5,0x1,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x6,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x2,0x2,0x2,0x5,0x1,0x4,0x4,0x4,0x4,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x3,0x6,0x1,0x6,0x0},
      {0x0,0x6,0x7,0x6,0x6,0x6,0x6,0x6,0x2,0x2,0x2,0x2,0x5,0x5,0x5,0x3,0x3,0x3,0x7,0x6,0x6,0x6,0x1,0x1,0x1,0x4,0x4,0x4,0x6,0x1,0x6,0x0},
      {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0}
};





/***************************************************************************

  Start the video hardware emulation.

***************************************************************************/
int invaders_vh_start (void)
{
	if ((tmpbitmap = osd_create_bitmap(Machine->drv->screen_width,Machine->drv->screen_height)) == 0)
		return 1;

	return 0;
}


/***************************************************************************

  Stop the video hardware emulation.

***************************************************************************/
void invaders_vh_stop (void)
{
	osd_free_bitmap (tmpbitmap);
}

static void plot_pixel_8080 (int x, int y, int col)
{
	if (Machine->orientation & ORIENTATION_SWAP_XY)
	{
		int temp;

		temp = x;
		x = y;
		y = temp;
	}
	if (Machine->orientation & ORIENTATION_FLIP_X)
		x = 255 - x;
	if (Machine->orientation & ORIENTATION_FLIP_Y)
		y = 255 - y;

	tmpbitmap->line[y][x] = col;
	/* TODO: we should mark 8 bits dirty at a time */
	osd_mark_dirty (x,y,x,y,0);
}

void invaders_videoram_w (int offset,int data)
{
	if (invaders_videoram[offset] != data)
	{
		int i,x,y;
		int col;

		invaders_videoram[offset] = data;

		y = offset / 32;
		x = 8 * (offset % 32);

		/* Calculate overlay color for this byte */
		col = Machine->pens[WHITE];
		if (x >= 16 && x < 72) col = Machine->pens[GREEN];
		if (x < 16 && y > 16 && y < 134) col = Machine->pens[GREEN];
		if (x >= 192 && x < 224) col = Machine->pens[RED];

		for (i = 0; i < 8; i++)
		{
			if (!(data & 0x01))
				plot_pixel_8080 (x, y, Machine->pens[BLACK]);
			else
				plot_pixel_8080 (x, y, col);

			x ++;
			data >>= 1;
		}
	}
}

void invrvnge_videoram_w (int offset,int data)
{
	if (invaders_videoram[offset] != data)
	{
		int i,x,y;
		int col;

		invaders_videoram[offset] = data;

		y = offset / 32;
		x = 8 * (offset % 32);

		/* Calculate overlay color for this byte */
		col = Machine->pens[WHITE];
		if (x < 72) col = Machine->pens[GREEN];
		if (x >= 192 && x < 224) col = Machine->pens[RED];

		for (i = 0; i < 8; i++)
		{
			if (!(data & 0x01))
				plot_pixel_8080 (x, y, Machine->pens[BLACK]);
			else
				plot_pixel_8080 (x, y, col);

			x ++;
			data >>= 1;
		}
	}
}


void lrescue_videoram_w (int offset,int data)
{
	if (invaders_videoram[offset] != data)
	{
		int i,x,y;
		int col;

		invaders_videoram[offset] = data;

		y = offset / 32;
		x = 8 * (offset % 32);

		/* Calculate overlay color for this byte */
		col = Machine->pens[WHITE];

		if (x >= 240 && x < 248)
		{
			if (y < 72) col = Machine->pens[CYAN];
			if (y >= 72 && y < 152) col = Machine->pens[RED];
			if (y >= 152) col = Machine->pens[YELLOW];
		}
		if (x >= 232 && x < 240)
		{
			if (y < 72) col = Machine->pens[CYAN];
			if (y >= 72 && y < 160) col = Machine->pens[GREEN];
			if (y >= 160) col = Machine->pens[YELLOW];
		}
		if (x >= 224 && x < 232)
		{
			if (y >= 72 && y < 160) col = Machine->pens[GREEN];     /* or 152? */
			if (y >= 160) col = Machine->pens[YELLOW];
		}

		if (x >= 216 && x < 224) col = Machine->pens[RED];
		if (x >= 192 && x < 216) col = Machine->pens[PURPLE];
		if (x >= 160 && x < 192) col = Machine->pens[GREEN];
		if (x >= 128 && x < 160) col = Machine->pens[CYAN];
		if (x >= 96 && x < 128) col = Machine->pens[PURPLE];
		if (x >= 64 && x < 96) col = Machine->pens[YELLOW];
		if (x >= 40 && x < 64) col = Machine->pens[RED];
		if (x >= 24 && x < 40) col = Machine->pens[CYAN];
		if (x >= 16 && x < 24) col = Machine->pens[RED];
		if (x < 16)
		{
			if (y < 136) col = Machine->pens[CYAN];
			if (y >= 136 && y < 192) col = Machine->pens[PURPLE];
			if (y >= 192) col = Machine->pens[CYAN];
		}
		if (y == 223) col = Machine->pens[BLACK];

		for (i = 0; i < 8; i++)
		{
			if (!(data & 0x01))
				plot_pixel_8080 (x, y, Machine->pens[BLACK]);
			else
				plot_pixel_8080 (x, y, col);

			x ++;
			data >>= 1;
		}
	}
}


void rollingc_videoram_w (int offset,int data)
{
	if (invaders_videoram[offset] != data)
	{
		int i,x,y;

		invaders_videoram[offset] = data;

		y = offset / 32;
		x = 8 * (offset % 32);

		for (i = 0; i < 8; i++)
		{
			if (!(data & 0x01))
				plot_pixel_8080 (x, y, Machine->pens[16]);
			else
				plot_pixel_8080 (x, y, Machine->pens[RAM[0xa400 + offset] & 0x0f]);

			x ++;
			data >>= 1;
		}
	}
}


/* Bandido has an optional colour kit than can be added on  */  /* MJC */
/* this includes a rom image that we do not yet have, so .. */

void boothill_videoram_w (int offset,int data)
{
	if (invaders_videoram[offset] != data)
	{
		int i,x,y;

		invaders_videoram[offset] = data;

		y = offset / 32;
		x = 8 * (offset % 32);

		for (i = 0; i < 8; i++)
		{
			if (!(data & 0x01))
				plot_pixel_8080 (x, y, Machine->pens[BLACK]);
			else
				plot_pixel_8080 (x, y, Machine->pens[WHITE]);

			x ++;
			data >>= 1;
		}
	}
}


void astinvad_videoram_w (int offset,int data)
{
	if (invaders_videoram[offset] != data)
	{
		int i,x,y;

		invaders_videoram[offset] = data;

		y = offset / 32;
		x = 8 * (offset % 32);

		for (i = 0; i < 8; i++)
		{
			if (!(data & 0x01))
				plot_pixel_8080 (x, y, Machine->pens[BLACK]);
			else
				plot_pixel_8080 (x, y, Machine->pens[astinvad_lookup[31-y/8][31-x/8]]);

			x ++;
			data >>= 1;
		}
	}
}



/***************************************************************************

  Draw the game screen in the given osd_bitmap.
  Do NOT call osd_update_display() from this function, it will be called by
  the main emulation engine.

***************************************************************************/
void invaders_vh_screenrefresh(struct osd_bitmap *bitmap)
{
	/* copy the character mapped graphics */
	copybitmap(bitmap,tmpbitmap,0,0,0,0,&Machine->drv->visible_area,TRANSPARENCY_NONE,0);
}
